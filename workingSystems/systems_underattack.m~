clear;
clc;

%%%%%%%%%%%%%%%%%%%%%%%%%%% Power grid %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
A=[-1 -3;3 -5];
B=[2 -1;1 0];
C=[0.8 2.4;1.6 0.8];
D=zeros(size(C,1),size(B,2));
K=[2];

Ts = 1;
pgrid = ss(A,B,C,D);
pgrid_d=ss(A,B,C,zeros(size(B)),Ts);
controllability_cc=[rank(pgrid_d.a)==rank(ctrb(pgrid_d))];
p = 100;
Q = p*eye(size(A));
R = 0.1*eye(size(B,2),size(B,2));
K = dlqr(A,B,Q,R)
pgrid_cl =ss(A-B*K,zeros(size(B)),C,D,Ts);
isstable(pgrid_cl)
% pgrid_cl =ss(A-B*K,B,C,D,Ts);
step(pgrid_cl)

QN =1;
RN = eye(size(C,1));
[KEST,L,PN] = kalman(pgrid_d,QN,RN)

for i=1:10000000
    L=(PN*C')/(C*PN*C'+RN);
    PN=(eye(size(C,1))-L*C)*PN;
    PN=(A*PN*A'+QN);
end

time = 500;
plot_vector1 = ones(1,time);
plot_vector2 = ones(1,time);
plot_vector3 = ones(1,time);
plot_vector4 = ones(1,time);


x = ones(size(A,1),1);
z = 2*ones(size(A,1),1);
u = zeros(size(A,1),1);

for i=1:time
    y = C*x
    r = C*x - C*z;
    x = A*x + B*u;
    z = A*z + B*u + L*r;
    u = -K*x;
    
    plot_vector1(i) = x(1);
    plot_vector2(i) = z(1);
end

fontsize = 10;
linewidth = 1;

clf;
subplot(1,2,1);
hold on;
plot(plot_vector1,'LineWidth',linewidth);
plot(plot_vector2,'LineWidth',linewidth);
set(gca,'FontSize',fontsize)
grid on;
hold off;

% subplot(1,2,2);
% hold on;
% plot(plot_vector3,'LineWidth',linewidth);
% plot(plot_vector4,'LineWidth',linewidth);
% set(gca,'FontSize',fontsize)
% grid on;
% hold off;

